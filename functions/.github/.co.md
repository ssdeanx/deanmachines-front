# GitHub Copilot Instructions for DeanMachines Mastra Backend (v7.0 - FULL CODE & ANNOTATION)

**Document Objective:** Provide Copilot with the **complete, annotated source code** and **deep contextual explanations** for critical files within `functions/src/mastra/`, directly leveraging the provided `repomix.txt`. This code-first approach aims to give Copilot the necessary grounding to assist accurately and effectively in fixing the `mastra dev` streaming failure (`GOAL-001`), implementing OTLP tracing (`GOAL-002`), and refactoring agent configurations (`GOAL-REFACTOR-001`).

**Core Principle:** **Show the full code.** Annotate extensively. Explain mechanisms *through* the code. Provide explicit targets for modification. Maximize actionable detail for the priority tasks.

**IMMEDIATE HIGH-PRIORITY GOALS:**

1.  `GOAL-001`: **(CRITICAL) Fix `mastra dev` Streaming Failure:** Resolve `writerAgent` stream failure in local dev (`pnpm dev` in `functions`). See **Section 5 (Debugging Guide)**.
2.  `GOAL-002`: **(CRITICAL) Implement OTLP Tracing:** Configure & integrate Mastra telemetry for SigNoz. See **Section 2 (Telemetry Implementation)**.
3.  `GOAL-REFACTOR-001`: **(HIGH PRIORITY) Refactor Agent Configs:** Remove redundant `getToolsFromIds`. See **Section 3 (Agent Config Refactoring)**.

---

## 1. Development Context: `mastra dev` Environment

*   **Focus:** All subsequent code and instructions pertain **only** to the **`mastra dev`** environment (`pnpm dev` in `functions`).
*   **Execution:** Runs TS code in `functions/src/mastra/**` directly. **No Firebase/Genkit.**
*   **Debugging:** Relies on **`mastra dev` console output**.
*   **API:** `http://localhost:4111`.
*   **OTLP Target:** Local SigNoz at `http://localhost:4318`.

---

## 2. Telemetry Implementation (`GOAL-002`)

**Objective:** Configure Mastra to send OTLP traces to SigNoz by modifying `mastra.config.ts` and `mastra/index.ts`.

**File 1: `functions/mastra.config.ts` (`FILE-CONFIG-MASTRA-GLOBAL`)**

*   **Purpose:** Defines the global `telemetry` configuration object (`COMP-OBSERVABILITY-OTLP`) used by the Mastra instance.
*   **Action:** Ensure this file defines and exports the `telemetry` object correctly, reading endpoint/headers from environment variables.
*   **Full Code & Target State (`FILE-CONFIG-MASTRA-GLOBAL`):**

    ```typescript
    // Source Code & Target State: functions/mastra.config.ts
    // ======================================================
     1  import { Mastra } from "@mastra/core"; // [NOTE] These imports might be unnecessary if only exporting config
     2  import { createLogger } from "@mastra/core/logger"; // [NOTE] These imports might be unnecessary if only exporting config
     3  import agents from "./src/mastra/agents"; // [NOTE] These imports might be unnecessary if only exporting config
     4  import { ragWorkflow, networks } from "./src/mastra/workflows"; // [NOTE] These imports might be unnecessary if only exporting config
     5  // [NOTE] Consider removing lines 1-4 if they are not used within this file.
     6  // [NOTE] Assuming TelemetryConfig type exists or define inline structure.
     7  // import { TelemetryConfig } from '@mastra/core';
     8
     9  // [ANNOTATION] Helper function to parse comma-separated key=value pairs for OTLP headers.
    10  // Handles potential extra whitespace and invalid pairs.
    11  const parseOtlpHeaders = (): Record<string, string> | undefined => {
    12    const headersEnv = process.env.OTEL_EXPORTER_OTLP_HEADERS;
    13    if (!headersEnv) {
    14      console.log("[mastra.config.ts] No OTEL_EXPORTER_OTLP_HEADERS found.");
    15      return undefined;
    16    }
    17    try {
    18      const headers = Object.fromEntries(
    19        headersEnv.split(',')
    20          .map(h => {
    21            const trimmed = h.trim();
    22            const firstEqual = trimmed.indexOf('=');
    23            // Ensure '=' exists and is not the first or last character
    24            if (firstEqual <= 0 || firstEqual === trimmed.length - 1) return null;
    25            return [trimmed.substring(0, firstEqual).trim(), trimmed.substring(firstEqual + 1).trim()];
    26          })
    27          .filter((pair): pair is [string, string] => pair !== null && pair[0] !== '' && pair[1] !== '')
    28      );
    29      console.log(`[mastra.config.ts] Parsed OTLP Headers: ${JSON.stringify(headers)}`);
    30      return Object.keys(headers).length > 0 ? headers : undefined;
    31    } catch (e) {
    32      console.error("[mastra.config.ts] Error parsing OTEL_EXPORTER_OTLP_HEADERS:", e);
    33      return undefined;
    34    }
    35  };
    36
    37  // Export telemetry configuration to fix the dev server error
    38  // [ANNOTATION] This is the core configuration object for Mastra's OpenTelemetry integration.
    39  // It needs to be imported and passed to the Mastra constructor in mastra/index.ts.
    40  export const telemetry /*: TelemetryConfig */ = {
    41    // [ANNOTATION] Enable/disable tracing. Use env var, default true for dev.
    42    enabled: process.env.MASTRA_TELEMETRY_ENABLED !== 'false',
    43    // [ANNOTATION] Service name appearing in SigNoz/tracing backend.
    44    serviceName: process.env.MASTRA_SERVICE_NAME || "deanmachines-ai-mastra",
    45    export: {
    46      // [ANNOTATION] Use the standard OpenTelemetry Protocol exporter.
    47      type: "otlp",
    48      // [ANNOTATION] Target OTLP collector endpoint. Read from env var, default to local SigNoz HTTP.
    49      // CRITICAL for GOAL-002: Ensure this default matches your local SigNoz setup.
    50      endpoint: process.env.OTEL_EXPORTER_OTLP_ENDPOINT || "http://localhost:4318",
    51      // [ANNOTATION] Optional headers for the OTLP exporter (e.g., auth). Read from env var.
    52      headers: parseOtlpHeaders(),
    53    },
    54    sampling: {
    55      // [ANNOTATION] Sampling strategy. 'always_on' is CRITICAL for debugging GOAL-001.
    56      // Change to 'ratio' (e.g., probability: 0.1) for production.
    57      type: 'always_on',
    58      // probability: 0.1 // Example for ratio sampling
    59    },
    60    // [ANNOTATION] Optional: Add resource attributes for better trace context in SigNoz.
    61    // resourceAttributes: {
    62    //   'deployment.environment': process.env.NODE_ENV || 'development',
    63    //   'service.version': 'v1.0.0', // Example: Read from package.json
    64    // },
    65  };
    66
    67  // [ANNOTATION] Log the final config for verification during startup.
    68  console.log("[mastra.config.ts] Telemetry Configuration Initialized:", JSON.stringify(telemetry, null, 2));
    69
    70  // Track request timing for RL metrics
    71  // [ANNOTATION] This comment suggests other global configs might be added here later.
    ```

*   **Environment Setup (`functions/.env`):** Ensure this file exists and contains:

    ```dotenv
    # Required for GOAL-002 debugging with mastra dev
    OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4318
    MASTRA_TELEMETRY_ENABLED=true
    # OTEL_EXPORTER_OTLP_HEADERS=Authorization=Bearer_YOUR_SIGNOZ_TOKEN # Example if needed
    ```

**File 2: `functions/src/mastra/index.ts` (`FILE-ENTRYPOINT-MASTRA`)**

*   **Purpose:** Initializes the `Mastra` instance (`COMP-MASTRA-INSTANCE`). **MUST be modified for `GOAL-002`.**
*   **Action (`IMPL-LOGDRAIN-003`):** Import `telemetry`, remove `serverOptions` variable and `server` property, add `telemetry` property to `new Mastra(...)`.
*   **Full Code & Annotations (`FILE-ENTRYPOINT-MASTRA`):**

    ```typescript
    // Source Code: functions/src/mastra/index.ts
    // ===========================================
     1  /**
     2   * DeanMachines AI Platform - Mastra Core Instance
     3   * ... (Doc comments) ...
     4   */
     5  import { Mastra } from '@mastra/core';
     6  import { createLogger } from '@mastra/core/logger';
     7  // [GOAL-002 ACTION]: Remove ServerOptions import if no longer needed after removing the config block.
     8  import { ServerOptions, StreamingOptions } from '@mastra/core/types';
     9  // [GOAL-002 ACTION]: Import the telemetry configuration object.
    10  // <<< --- ADD IMPORT HERE: import { telemetry } from '../mastra.config';
    11  import agents from './agents';
    12  import { ragWorkflow } from './workflows';
    13  import { networks } from './workflows/Networks/agentNetwork';
    14
    15  // Configure logger
    16  const logger = createLogger({ name: 'mastra-main', level: 'debug' }); // Use debug level for more info
    17
    18  // Configure streaming
    19  const streamingConfig: StreamingOptions = {
    20      chunkSize: 20,
    21      eventThrottleMs: 50,
    22      includeMetadata: true,
    23      fallbackToNonStreaming: true, // If streaming fails, attempt non-streaming response
    24  };
    25
    26  // [GOAL-002 ACTION]: Remove this entire 'serverOptions' block.
    27  // --- START BLOCK TO REMOVE ---
    28  const serverOptions: ServerOptions = {
    29    origin: "*", // CORS setting
    30    timeout: 120000,
    31    middleware: [
    32      async (req, _res, next) => {
    33        logger.debug(`Request received: ${req.method} ${req.url}`);
    34        (req as any).startTime = Date.now();
    35        await next();
    36        if ((req as any).startTime) {
    37           const duration = Date.now() - (req as any).startTime;
    38           logger.info(`Request finished: ${req.method} ${req.url} - ${duration}ms`);
    39        }
    40      },
    41    ],
    42  };
    43  // --- END BLOCK TO REMOVE ---
    44
    45  // Initialize the central Mastra instance
    46  logger.info("Initializing Mastra instance...");
    47  export const mastra = new Mastra({
    48    agents: agents,
    49    workflows: { ragWorkflow },
    50    networks: networks,
    51    logger: logger,
    52    // [GOAL-002 ACTION]: Add the imported telemetry configuration here.
    53    // <<< --- ADD PROPERTY HERE: telemetry: telemetry,
    54    streaming: streamingConfig,
    55    // [GOAL-002 ACTION]: Remove this server property.
    56    // server: serverOptions, // <<< --- REMOVE THIS LINE
    57  });
    58
    59  // [GOAL-002 ACTION]: Update log message to reflect telemetry initialization.
    60  logger.info("Mastra instance initialized.");
    61  // [ANNOTATION] Log loaded components for verification during startup.
    62  logger.info(`Registered Agents: ${Object.keys(agents).join(', ')}`);
    63  logger.info(`Registered Workflows: ${Object.keys({ ragWorkflow }).join(', ')}`);
    64  logger.info(`Registered Networks: ${Object.keys(networks).join(', ')}`);
    65  // [GOAL-002 ACTION]: Add log to show telemetry config being used (requires telemetry import).
    66  // <<< --- ADD LOG HERE: logger.info(`Telemetry Config Used: ${JSON.stringify(telemetry)}`);
    67
    68  /**
    69   * Creates a properly formatted streaming response (SSE)
    70   * [ANNOTATION] This function formats the raw stream from an agent into SSE format.
    71   * It's likely used by the API layer that serves Mastra (e.g., mastra dev's internal server,
    72   * or potentially your Firebase Functions if they handle streaming directly).
    73   * Keep this function as it might be necessary for stream handling.
    74   */
    75  export const createStreamResponse = (stream: ReadableStream): Response => {
    76    const body = new ReadableStream({
    77      async start(controller) {
    78        const reader = stream.getReader();
    79        const decoder = new TextDecoder();
    80        try {
    81          while (true) {
    82            const { done, value } = await reader.read();
    83            if (done) break;
    84            const chunk = decoder.decode(value, { stream: true });
    85            // Format as SSE 'data:' event
    86            controller.enqueue(`data: ${chunk}\n\n`);
    87          }
    88        } catch (error) {
    89          logger.error('Streaming error in createStreamResponse:', error);
    90          // Send error within the SSE stream if possible
    91          try {
    92             controller.enqueue(`data: ${JSON.stringify({ error: 'Stream processing error', details: error.message })}\n\n`);
    93          } catch (e) {/* Ignore if controller is already closed */}
    94        } finally {
    95          try {
    96             controller.close();
    97          } catch (e) {/* Ignore if controller is already closed */}
    98          logger.debug('SSE stream closed in createStreamResponse.');
    99        }
   100      },
   101    });
   102
   103    return new Response(body, {
   104      headers: {
   105        "Content-Type": "text/event-stream",
   106        "Cache-Control": "no-cache",
   107        "Connection": "keep-alive",
   108        // Optional: Add CORS headers here if needed, though often handled by the server/gateway
   109        // "Access-Control-Allow-Origin": "*",
   110      },
   111    });
   112  };
    ```

*   **Verification:** Run `mastra dev`. Check console logs for successful initialization and telemetry config logging. Make API calls and verify traces appear in SigNoz.
*   `SUG-IMPL-LOGDRAIN-001`: "@workspace Refactor `#file:functions/src/mastra/index.ts`: Remove the `server` option/variable and add the `telemetry` option, importing the config from `FILE-CONFIG-MASTRA-GLOBAL`, matching the target code shown in `FILE-CONTEXT-COPILOT` section 2."

---

## 4. Agent Config Refactoring (`GOAL-REFACTOR-001`)

*   **Objective:** Remove the redundant `getToolsFromIds` function from all files in `functions/src/mastra/agents/config/` (`FILE-AGENT-CONFIG`).
*   **Reasoning:** Tool resolution is **centralized** in the Agent Factory (`COMP-AGENT-FACTORY` in `FILE-AGENT-BASE`), which uses the `toolIds` array from the config object and the central `allToolsMap` from `tools/index.ts`. The duplicated function is unnecessary.
*   **Component:** `COMP-AGENT-FACTORY` (`createAgentFromConfig` in `FILE-AGENT-BASE`).
    *   **Full Code (`FILE-AGENT-BASE`):**

        ```typescript
        // Source Code: functions/src/mastra/agents/base.agent.ts
        // ======================================================
         1  /**
         2   * Base Agent Implementation
         3   *
         4   * This module provides utility functions to create agents from configurations,
         5   * ensuring consistent agent creation patterns across the application.
         6   */
         7  import { StreamResult } from '@mastra/core'; // [NOTE] Verify if StreamResult is actually used here
         8  import { Agent, AgentGenerateOptions } from '@mastra/core/agent'; // Import AgentGenerateOptions if needed for hooks
         9  import { createLogger } from '@mastra/core/logger';
        10  import { Tool } from '@mastra/core/tools';
        11  import { CoreMessage } from 'ai'; // Import CoreMessage if used in hooks/logic
        12
        13  // [ANNOTATION] Import the central, shared memory instance.
        14  import { sharedMemory } from '../database';
        15  // [ANNOTATION] Import hook creation utility (if used beyond response hook).
        16  import { createResponseHook } from '../hooks';
        17  // [ANNOTATION] CRITICAL: Import the central tool registry map.
        18  import { allToolsMap } from '../tools';
        19  // [ANNOTATION] Import base config types and model creation utilities.
        20  import {
        21    BaseAgentConfig,
        22    createModelInstance, // Utility to create Google/Vertex model instance
        23    DEFAULT_MAX_CONTEXT_TOKENS, // Constants (potentially unused here)
        24    DEFAULT_MAX_TOKENS,         // Constants (potentially unused here)
        25    DEFAULT_MODEL_ID,           // Constants (potentially unused here)
        26    defaultErrorHandler,        // Default onError handler
        27    defaultResponseValidation,  // Default response validation options
        28    ResponseHookOptions,        // Type for response hook options
        29    ModelCreationOptions,       // Type for model creation options
        30  } from './config';
        31
        32  // Configure logger for agent initialization
        33  const logger = createLogger({ name: 'agent-factory', level: 'debug' });
        34
        35  /**
        36   * Creates an agent instance from a configuration object and options.
        37   * This is the central factory for all agents in the system.
        38   *
        39   * @param params - Object containing configuration and agent options.
        40   * @param params.config - The agent configuration object (BaseAgentConfig).
        41   * @param params.memory - The shared memory instance (e.g., LibSQLStore via sharedMemory).
        42   * @param params.onError - Optional custom error handler callback function.
        43   * @returns A configured Agent instance from @mastra/core.
        44   * @throws Error if required tools specified in config.toolIds are not found in allToolsMap.
        45   */
        46  export function createAgentFromConfig({
        47    config,
        48    memory, // Type should be typeof sharedMemory or the specific Memory class type
        49    onError,
        50  }: {
        51    config: BaseAgentConfig;
        52    memory: typeof sharedMemory; // Use inferred type or specific Memory type
        53    onError?: (error: Error) => Promise<Record<string, unknown>>; // Match defaultErrorHandler signature
        54  }): Agent { // Explicit return type
        55    logger.info(`Creating agent from config: ${config.id} (Name: ${config.name})`);
        56    logger.debug(`Agent Config Received: ${JSON.stringify(config)}`);
        57
        58    // Validate configuration basics (add more checks if needed)
        59    if (!config || !config.id || !config.name || !config.modelConfig || !config.instructions) {
        60        logger.error("Invalid agent configuration provided:", config);
        61        throw new Error("Invalid agent configuration: Missing required fields (id, name, modelConfig, instructions).");
        62    }
        63
        64    // --- Tool Resolution Mechanism ---
        65    // [ANNOTATION] This block resolves tool IDs from the config against the central tool map.
        66    // This makes the getToolsFromIds function in individual config files redundant (GOAL-REFACTOR-001).
        67    const resolvedTools: Tool[] = []; // Initialize as Tool array
        68    if (!config.toolIds || !Array.isArray(config.toolIds)) {
        69        // If toolIds is missing or not an array, log a warning but proceed (agent might have no tools)
        70        logger.warn(`Agent config "${config.id}" has missing or invalid 'toolIds' array. Agent will have no tools.`);
        71    } else {
        72        config.toolIds.forEach(id => {
        73            const tool = allToolsMap.get(id); // <<< Lookup in central map
        74            if (!tool) {
        75                // Log detailed error for easier debugging
        76                logger.error(`Configuration Error: Tool ID "${id}" specified in agent config "${config.id}" was not found in the central 'allToolsMap'.`);
        77                logger.error(`Available tool IDs in allToolsMap: [${Array.from(allToolsMap.keys()).join(', ')}]`);
        78                // Throw a specific error to halt agent creation if a tool is missing
        79                throw new Error(`Missing required tool "${id}" for agent "${config.id}". Check tool registration in tools/index.ts.`);
        80            }
        81            resolvedTools.push(tool); // Add the found Tool object
        82        });
        83    }
        84    logger.info(`Agent "${config.id}" resolved tools: [${resolvedTools.map(t => t.id).join(', ')}]`);
        85    // --- End Tool Resolution ---
        86
        87    // --- Model Instantiation ---
        88    // [ANNOTATION] Uses the utility function to create the correct AI SDK model instance.
        89    // Assumes createModelInstance handles provider logic (google vs vertex) and options.
        90    // Potential place for errors if modelConfig is invalid or credentials are missing.
        91    let model;
        92    try {
        93        // [NOTE] Pass necessary options if createModelInstance requires them (e.g., API keys, project ID)
        94        // These might come from env vars or a secure config source.
        95        const modelOptions: ModelCreationOptions = {
        96            // Example: Pass env vars if needed by the utility
        97            // vertexProjectId: process.env.GOOGLE_PROJECT_ID,
        98            // vertexLocation: process.env.VERTEX_AI_LOCATION,
        99            // googleApiKey: process.env.GOOGLE_API_KEY,
       100        };
       101        model = createModelInstance(config.modelConfig, modelOptions);
       102        logger.debug(`Agent "${config.id}" using model: ${config.modelConfig.provider}/${config.modelConfig.modelId}`);
       103    } catch (error) {
       104        logger.error(`Failed to create model instance for agent "${config.id}":`, error);
       105        logger.error(`Model Config was: ${JSON.stringify(config.modelConfig)}`);
       106        throw new Error(`Model creation failed for agent "${config.id}": ${error.message}`);
       107    }
       108    // --- End Model Instantiation ---
       109
       110    // --- Hook Setup ---
       111    // [ANNOTATION] Sets up hooks for agent lifecycle events.
       112    // Create response hook if validation options are provided in config
       113    const responseHook = config.responseValidation
       114        ? createResponseHook(config.responseValidation)
       115        : undefined;
       116
       117    // Create debug logger specifically for streaming operations (relevant for GOAL-001)
       118    const streamLogger = createLogger({
       119        name: `agent-${config.id}-stream`, // Unique name for stream logs
       120        level: "debug", // Use debug level for detailed stream info
       121        // Pass additional context if the logger supports it
       122        // defaultMeta: { component: `${config.id}-stream`, agentId: config.id }
       123    });
       124
       125    // [ANNOTATION] Define the hooks object passed to the Agent constructor.
       126    // Check Mastra documentation (EXT-CTX-001) for the exact supported hook names and signatures.
       127    // The __experimental_ prefixes suggest these might change.
       128    const hooks = {
       129        // [ANNOTATION] Hook executed after a response (non-streaming or full streaming) is generated.
       130        onGenerateResponse: responseHook, // Apply validation/modification hook if defined
       131
       132        // [ANNOTATION] Hook executed before the agent starts processing a stream request.
       133        // Useful for logging the initiation of the stream (GOAL-001 debugging).
       134        __experimental_onStreamStart: async (options: AgentGenerateOptions) => { // Use correct type
       135            // Log relevant options, be mindful of sensitive data.
       136            streamLogger.debug('Stream processing started.', { agentId: config.id /*, options: JSON.stringify(options) */ });
       137            // This hook might not need to return anything, check Mastra docs.
       138        },
       139
       140        // [ANNOTATION] Hook executed after the stream has successfully completed.
       141        __experimental_onStreamEnd: async (result: StreamResult | any) => { // Use correct type
       142            streamLogger.debug('Stream processing ended successfully.', { agentId: config.id /*, result */ });
       143        },
       144
       145        // [ANNOTATION] Hook executed if an error occurs DURING stream processing.
       146        // CRITICAL for debugging GOAL-001.
       147        __experimental_onStreamError: async (streamError: Error) => {
       148            streamLogger.error('Error occurred during stream processing!', {
       149                agentId: config.id,
       150                error: streamError.message,
       151                name: streamError.name,
       152                stack: streamError.stack
       153            });
       154            // Decide whether to re-throw or handle the error here.
       155            // Re-throwing might be appropriate to let the caller know.
       156            // throw streamError;
       157        },
       158        // Add other potential hooks like onToolStart, onToolEnd, etc. if needed/supported
       159    };
       160    // --- End Hook Setup ---
       161
       162    // --- Agent Instantiation ---
       163    // [ANNOTATION] Creates the final Agent instance using all configured parts.
       164    try {
       165        const agent = new Agent({
       166            // Core Identity & Behavior
       167            name: config.name, // Used in logging & potentially tracing
       168            description: config.description,
       169            instructions: config.instructions,
       170            // Resolved/Created Components
       171            model: model, // The AI SDK model instance
       172            tools: resolvedTools, // Array of resolved Mastra Tool objects
       173            memory: memory, // Injected shared memory instance
       174            hooks: hooks, // Lifecycle hooks
       175            // Use provided onError or the default one
       176            onError: onError || defaultErrorHandler,
       177            // Pass other valid Agent constructor options from BaseAgentConfig if needed
       178            // e.g., responseSchema: config.responseSchema // If agent supports direct schema
       179        });
       180        logger.info(`Agent "${config.id}" created successfully.`);
       181        return agent;
       182    } catch (error) {
       183        logger.error(`Failed to instantiate Agent "${config.id}" with constructor:`, error);
       184        // Log the resolved components that might have caused the issue
       185        logger.error(`Resolved Tools for "${config.id}": ${JSON.stringify(resolvedTools.map(t => t.id))}`);
       186        logger.error(`Model Config for "${config.id}": ${JSON.stringify(config.modelConfig)}`);
       187        throw error; // Re-throw instantiation error
       188    }
       189  }
        ```

*   **Refactoring Action (`GOAL-REFACTOR-001`):** Delete the `getToolsFromIds` function definition block completely from *every* `*.config.ts` file in `FILE-AGENT-CONFIG`. Ensure the `toolIds: string[]` array remains in the exported config object.
*   **Example Target Code (`*.config.ts` - After Refactor):**

    ```typescript
    // Target State: functions/src/mastra/agents/config/ANY_AGENT.config.ts
    import { z } from "zod"; // Or other necessary imports
    import { BaseAgentConfig, /*...*/ } from "./config.types";

    // NO getToolsFromIds function definition HERE

    export const specificAgentConfig: BaseAgentConfig = {
      id: "specific-agent-id", /* ... */
      toolIds: [ /* ... list of tool IDs ... */ ], // <<< Array MUST remain
      /* ... other config properties ... */
    };
    // ... schema, types ...
    ```

*   `SUG-REFACTOR-001`: **(High Priority)** "@workspace Apply the refactoring for `GOAL-REFACTOR-001`. Edit each `*.config.ts` file in `#file:functions/src/mastra/agents/config/` to remove the `getToolsFromIds` function definition entirely, leaving the `toolIds` array intact within the exported config object, as shown in the target state example in `FILE-CONTEXT-COPILOT` section 4."
*   `PLAN-REFACTOR-001`: "@workspace Use the Software Planning Tool: `start_planning` goal='Refactor Agent Configs (GOAL-REFACTOR-001)'. Add `add_todo` title='Remove getToolsFromIds from Configs' description='Delete redundant function from all files in FILE-AGENT-CONFIG. Verify toolIds array. Ref: FIND-REDUNDANCY-001, SUG-REFACTOR-001.' complexity=3."

---

## 5. Tool Integration & Adapters (`tools/index.ts`)

*   **File:** `FILE-DIR-TOOLS`/`index.ts`
*   **Purpose:** Central registry (`allToolsMap`) for all tools usable by agents. Implements the **Tool Adapter Pattern** using `createMastraTools` (`COMP-ADAPTER-MASTRA`) from `@agentic/mastra` to make tools from the `@agentic/*` ecosystem compatible with Mastra's `Tool` interface.
*   **Full Code & Annotations (`FILE-DIR-TOOLS/index.ts`):**

    ```typescript
    // Source Code: functions/src/mastra/tools/index.ts
    // ======================================================
      1  /**
      2   * Tool Registry and Management
      3   * ... (Doc comments) ...
      4   * @module Tools
      5   */
      6
      7  // === Standard library imports ===
      8  import { env } from "process";
      9
     10  // === Third-party imports ===
     11  import { z, ZodTypeAny } from "zod"; // Import ZodTypeAny
     12  import { Tool, createTool } from "@mastra/core/tools";
     13  import { createLogger } from "@mastra/core/logger";
     14  // [ANNOTATION] The core adapter function from @agentic/mastra.
     15  import { createMastraTools } from "@agentic/mastra";
     16
     17  // === Internal tool imports ===
     18  // [ANNOTATION] Native Mastra tools (likely using createTool directly)
     19  import {
     20    vectorQueryTool,
     21    googleVectorQueryTool,
     22    filteredQueryTool,
     23  } from "./vectorquerytool";
     24  import { readFileTool, writeToFileTool } from "./readwrite";
     25  import {
     26    collectFeedbackTool,
     27    analyzeFeedbackTool,
     28    applyRLInsightsTool,
     29  } from "./rlFeedback";
     30  import {
     31    calculateRewardTool,
     32    defineRewardFunctionTool,
     33    optimizePolicyTool,
     34  } from "./rlReward";
     35  import { memoryQueryTool } from "./memoryQueryTool";
     36  import { analyzeContentTool, formatContentTool } from "./contentTools";
     37  import { searchDocumentsTool, embedDocumentTool } from "./document-tools";
     38  // [ANNOTATION] GraphRag tools - ensure they export Mastra Tool instances or are adapted.
     39  import { createGraphRagTool, graphRagQueryTool } from "./graphRag";
     40
     41  // --- Import factories/providers for Agentic tools that need adaptation ---
     42  import { createBraveSearchTool as createAgenticBraveSearch } from "./brave-search";
     43  import { createGoogleSearchTool as createAgenticGoogleSearch } from "./google-search";
     44  import { createTavilySearchTool as createAgenticTavily } from "./tavily";
     45  // [ANNOTATION] Exa search factory returns already adapted Mastra tools.
     46  import { createMastraExaSearchTools } from "./exasearch";
     47  import { createCalculatorTool as createAgenticCalculator } from "./calculator";
     48  // [ANNOTATION] LlamaIndex factory needs adaptation.
     49  import { createLlamaIndexTools as createAgenticLlamaIndexTools } from "./llamaindex";
     50  // [ANNOTATION] GitHub factory returns already adapted Mastra tools.
     51  import { createMastraGitHubTools } from "./github";
     52  // [ANNOTATION] Wikipedia factory needs adaptation.
     53  import { createWikipediaClient as createAgenticWikipediaClient } from "./wikibase";
     54  // [ANNOTATION] E2B factory needs adaptation.
     55  import { createE2BSandboxTool as createAgenticE2BTool } from "./e2b";
     56  // [ANNOTATION] AI SDK tool factory needs adaptation.
     57  import { createAISDKTools as createAgenticAISDKTools } from "./ai-sdk";
     58  // [ANNOTATION] LLM Chain tool factory needs adaptation.
     59  import { createMastraLLMChainTools } from "./llmchain"; // Assuming this returns adapted tools
     60  // [ANNOTATION] MCP Tool (Commented Out - Potential cause of GOAL-001)
     61  // import { createMcpTools } from "@agentic/mcp";
     62  // import { createMastraMcpTools } from "./mcptools"; // Async factory
     63
     64  // === Configure Logger ===
     65  const logger = createLogger({ name: 'tool-registry', level: 'info' });
     66
     67  // === Environment Configuration ===
     68  // [ANNOTATION] Schema to validate required API keys from environment variables.
     69  const envSchema = z.object({
     70      BRAVE_API_KEY: z.string().optional(),
     71      GOOGLE_CSE_ID: z.string().optional(),
     72      GOOGLE_API_KEY: z.string().optional(), // For CSE and potentially others
     73      TAVILY_API_KEY: z.string().optional(),
     74      EXA_API_KEY: z.string().optional(),
     75      GITHUB_API_KEY: z.string().optional(),
     76      E2B_API_KEY: z.string().optional(),
     77      // Add other keys as needed (e.g., PINECONE_API_KEY, OPENAI_API_KEY)
     78  }).passthrough(); // Allow other env vars
     79
     80  export type EnvConfig = z.infer<typeof envSchema>;
     81
     82  function validateConfig(): EnvConfig {
     83      const result = envSchema.safeParse(process.env);
     84      if (!result.success) {
     85          logger.error("Environment variable validation failed:", result.error.format());
     86          // Decide whether to throw or proceed with potentially missing keys
     87          // throw new Error("Missing required environment variables for tools.");
     88          logger.warn("Proceeding with potentially missing API keys for tools.");
     89          return process.env as EnvConfig; // Return potentially incomplete env
     90      }
     91      logger.info("Tool environment configuration validated.");
     92      return result.data;
     93  }
     94  const envConfig = validateConfig();
     95
     96  // === Initialize Central Tool Map ===
     97  // [ANNOTATION] This map holds ALL tools available to agents. Key is the tool's unique 'id'.
     98  export const allToolsMap = new Map<string, Tool<any, any>>();
     99
    100  // === Helper Function for Registration ===
    101  // [ANNOTATION] Simplifies adding tools to the map, checking for ID conflicts.
    102  function registerTool(tool: Tool<any, any> | undefined) {
    103      if (tool && tool.id) {
    104          if (allToolsMap.has(tool.id)) {
    105              logger.warn(`Tool ID conflict: Tool with ID "${tool.id}" already registered. Overwriting.`);
    106          }
    107          allToolsMap.set(tool.id, tool);
    108          logger.debug(`Registered tool: ${tool.id}`);
    109      } else {
    110          logger.warn("Attempted to register an invalid or undefined tool:", tool);
    111      }
    112  }
    113
    114  // === Register Native Mastra Tools ===
    115  logger.info("Registering native Mastra tools...");
    116  registerTool(readFileTool);
    117  registerTool(writeToFileTool); // ID: 'write-file'
    118  registerTool(memoryQueryTool); // ID: 'memory-query'
    119  registerTool(vectorQueryTool); // ID: 'vector-query'
    120  registerTool(googleVectorQueryTool); // ID: 'google-vector-query'
    121  registerTool(filteredQueryTool); // ID: 'filtered-vector-query'
    122  registerTool(collectFeedbackTool); // ID: 'collect-feedback'
    123  registerTool(analyzeFeedbackTool); // ID: 'analyze-feedback'
    124  registerTool(applyRLInsightsTool); // ID: 'apply-rl-insights'
    125  registerTool(calculateRewardTool); // ID: 'calculate-reward'
    126  registerTool(defineRewardFunctionTool); // ID: 'define-reward-function'
    127  registerTool(optimizePolicyTool); // ID: 'optimize-policy'
    128  registerTool(analyzeContentTool); // ID: 'analyze-content'
    129  registerTool(formatContentTool); // ID: 'format-content'
    130  registerTool(searchDocumentsTool); // ID: 'search-documents'
    131  registerTool(embedDocumentTool); // ID: 'embed-document'
    132  registerTool(createGraphRagTool); // ID: 'create-graph-rag'
    133  registerTool(graphRagQueryTool); // ID: 'graph-rag-query'
    134  // [ANNOTATION] Alias for graph-rag tool needed by dataManagerAgent config
    135  if (allToolsMap.has('create-graph-rag')) {
    136      const graphRagTool = allToolsMap.get('create-graph-rag')!;
    137      registerTool({ ...graphRagTool, id: 'graph-rag' }); // Create alias with different ID
    138  }
    139
    140  // === Adapt and Register Agentic Tools ===
    141  logger.info("Adapting and registering Agentic tools...");
    142
    143  // --- Search Tools ---
    144  if (envConfig.BRAVE_API_KEY) {
    145      const provider = createAgenticBraveSearch({ apiKey: envConfig.BRAVE_API_KEY });
    146      const adapted = createMastraTools(provider);
    147      Object.values(adapted).forEach(registerTool); // Register all tools from provider
    148  } else logger.warn("Brave Search API Key not found, skipping tool.");
    149
    150  if (envConfig.GOOGLE_CSE_ID && envConfig.GOOGLE_API_KEY) {
    151      const provider = createAgenticGoogleSearch({ apiKey: envConfig.GOOGLE_API_KEY, cseId: envConfig.GOOGLE_CSE_ID });
    152      const adapted = createMastraTools(provider);
    153      Object.values(adapted).forEach(registerTool);
    154  } else logger.warn("Google Custom Search CSE ID or API Key not found, skipping tool.");
    155
    156  if (envConfig.TAVILY_API_KEY) {
    157      const provider = createAgenticTavily({ apiKey: envConfig.TAVILY_API_KEY });
    158      const adapted = createMastraTools(provider);
    159      Object.values(adapted).forEach(registerTool);
    160  } else logger.warn("Tavily API Key not found, skipping tool.");
    161
    162  if (envConfig.EXA_API_KEY) {
    163      // This factory returns already adapted tools
    164      const adaptedExaTools = createMastraExaSearchTools({ apiKey: envConfig.EXA_API_KEY });
    165      Object.values(adaptedExaTools).forEach(registerTool);
    166  } else logger.warn("Exa API Key not found, skipping tool.");
    167
    168  // --- Utility Tools ---
    169  const agenticCalculatorProvider = createAgenticCalculator();
    170  const adaptedCalc = createMastraTools(agenticCalculatorProvider);
    171  registerTool(adaptedCalc.calculator); // Assuming adapter returns { calculator: Tool }
    172
    173  if (envConfig.E2B_API_KEY) {
    174      const provider = createAgenticE2BTool({ apiKey: envConfig.E2B_API_KEY });
    175      const adapted = createMastraTools(provider);
    176      Object.values(adapted).forEach(registerTool);
    177  } else logger.warn("E2B API Key not found, skipping tool.");
    178
    179  // --- Integration Tools ---
    180  if (envConfig.GITHUB_API_KEY) {
    181      // This factory returns already adapted tools
    182      const adaptedGitHubTools = createMastraGitHubTools({ apiKey: envConfig.GITHUB_API_KEY });
    183      Object.values(adaptedGitHubTools).forEach(registerTool);
    184  } else logger.warn("GitHub API Key not found, skipping tool.");
    185
    186  // Wikipedia (no API key needed usually)
    187  const agenticWikipediaProvider = createAgenticWikipediaClient();
    188  const adaptedWiki = createMastraTools(agenticWikipediaProvider);
    189  Object.values(adaptedWiki).forEach(registerTool);
    190
    191  // LlamaIndex (assuming no specific config needed here)
    192  // [NOTE] Need to know what createAgenticLlamaIndexTools expects/returns
    193  // const agenticLlamaIndexTools = createAgenticLlamaIndexTools(/* ...args? */);
    194  // const adaptedLlamaIndex = createMastraTools(...agenticLlamaIndexTools); // Adapt if needed
    195  // Object.values(adaptedLlamaIndex).forEach(registerTool);
    196  logger.warn("LlamaIndex tool registration skipped (implementation details needed).");
    197
    198  // AI SDK Tools (assuming no specific config needed here)
    199  // [NOTE] Need to know what createAgenticAISDKTools expects/returns
    200  // const agenticAISDKTools = createAgenticAISDKTools(/* ...args? */);
    201  // const adaptedAISDK = createMastraTools(...agenticAISDKTools); // Adapt if needed
    202  // Object.values(adaptedAISDK).forEach(registerTool);
    203  logger.warn("AI SDK tool registration skipped (implementation details needed).");
    204
    205  // LLM Chain Tools (returns adapted tools)
    206  const adaptedLLMChainTools = createMastraLLMChainTools();
    207  Object.values(adaptedLLMChainTools).forEach(registerTool);
    208
    209  // --- MCP Tool (Commented Out - FIND-MCP-ISSUE-001 / GOAL-001) ---
    210  /*
    211  logger.info("Attempting to initialize MCP Tools (Async)...");
    212  createMastraMcpTools({ name: 'mcp', serverUrl: 'tcp://host.docker.internal:8811' })
    213      .then(adaptedMcpTools => {
    214          adaptedMcpTools.forEach(registerTool);
    215          logger.info(`MCP Tools initialized and registered: [${adaptedMcpTools.map(t=>t.id).join(', ')}]`);
    216          logger.info(`Total tools after MCP: ${allToolsMap.size}`);
    217      })
    218      .catch(error => {
    219          logger.error('Failed to initialize MCP Tools:', error);
    220          // Do not throw here, allow application to continue without MCP tools
    221      });
    222  */
    223  logger.warn("MCP Tool initialization is currently commented out.");
    224
    225  // === Log Final Tool Count ===
    226  logger.info(`Tool registration finished. Total tools registered: ${allToolsMap.size}`);
    227  logger.debug(`Final tool map keys: [${Array.from(allToolsMap.keys()).join(', ')}]`);
    228
    229  // === Grouped Exports (Optional) ===
    230  // export const searchTools = { /* ... */ };
    231  // export const fileTools = { /* ... */ };
    232
    233  // === Default Export (Optional) ===
    234  // export default allToolsMap; // Exporting the map directly
    ```

*   **Key Points:** This file is crucial. It defines the available tools (`allToolsMap`) used by `COMP-AGENT-FACTORY`. Errors here (missing keys, incorrect adaptation) will break agent creation. The MCP tool section must remain commented out for `GOAL-001`.

---

## 6. Observability Correlation & Services (`GOAL-002` Cont.)

*   **Objective:** Link programmatic logs (Langfuse/LangSmith) to OTLP traces (SigNoz).
*   **Pattern:** **OTLP Correlation Pattern** (`REL-OBS-004`).
*   **Mechanism:** Use `@opentelemetry/api` to get current `traceId`/`spanId` and pass them in metadata to Langfuse/LangSmith SDK calls.
*   **File 1: `functions/src/mastra/services/langfuse.ts` (`FILE-SVC-LANGFUSE`)**
    *   **Purpose:** Provides `LangfuseService` class wrapping the `langfuse` SDK.
    *   **Code Analysis:** The methods (`createTrace`, `createSpan`, `logGeneration`, `createScore`) accept options including `metadata`. This `metadata` field is where OTLP context should be added.

    ```typescript
    // Source Code: functions/src/mastra/services/langfuse.ts (Relevant Snippet)
    // =========================================================
    // ... (imports, setup) ...
    export class LangfuseService {
      private client: Langfuse;
      // ... (constructor) ...

      createTrace(name: string, options?: { userId?: string; metadata?: Record<string, unknown>; tags?: string[] }) {
        // [ANNOTATION] OTLP traceId/spanId should be added to options.metadata here by the CALLER
        return this.client.trace({ name, ...options });
      }

      createSpan(name: string, options: { traceId: string; parentSpanId?: string; input?: unknown; metadata?: Record<string, unknown>; tags?: string[] }) {
         // [ANNOTATION] OTLP traceId/spanId should be added to options.metadata here by the CALLER
        return this.client.span({ name, ...options });
      }

      logGeneration(name: string, options: { traceId: string; input: unknown; output?: unknown; promptTokens?: number; completionTokens?: number; model?: string; metadata?: Record<string, unknown>; tags?: string[] }) {
         // [ANNOTATION] OTLP traceId/spanId should be added to options.metadata here by the CALLER
        return this.client.generation({ name, ...options });
      }

      createScore(options: { name: string; value: number; traceId?: string; spanId?: string; generationId?: string; comment?: string; metadata?: Record<string, unknown> }) { // Added metadata option
        // [ANNOTATION] OTLP traceId/spanId should be added to options.metadata here by the CALLER
        // [ANNOTATION] Also consider passing OTLP traceId directly to Langfuse traceId if appropriate
        if (!options.traceId && !options.spanId && !options.generationId) {
          throw new Error("Score must target a traceId, spanId, or generationId.");
        }
        // Ensure metadata is passed through
        return this.client.score({ ...options });
      }
      // ... (flush) ...
    }
    export const langfuseService = new LangfuseService();
    ```

*   **File 2: `functions/src/mastra/services/langsmith.ts` (`FILE-SVC-LANGSMITH`)**
    *   **Purpose:** Provides LangSmith setup and manual logging functions.
    *   **Code Analysis:** `createLangSmithRun` and `trackFeedback` need modification or careful usage to include OTLP context. LangSmith might use `parentRunId` or metadata for correlation.

    ```typescript
    // Source Code: functions/src/mastra/services/langsmith.ts (Relevant Snippets)
    // ==========================================================
    // ... (imports, setup, configureLangSmithTracing) ...

    export async function createLangSmithRun(
      name: string,
      tags?: string[],
      // [ANNOTATION] Add parameters to accept OTLP context
      otelTraceId?: string,
      otelSpanId?: string,
      parentRunId?: string // LangSmith might use this for nesting/correlation
    ): Promise<string> {
      const runId = uuidv4(); // Generate UUID locally
      if (!langSmithClient) return runId; // Return local ID if client not configured

      try {
        // [ANNOTATION] Pass OTLP context to LangSmith if SDK supports it.
        // Check LangSmith SDK ('langsmith' package) documentation for correct fields.
        // Common patterns: 'parent_run_id', 'trace_id', or custom metadata.
        await langSmithClient.createRun({
          id: runId, // Use locally generated ID
          name: name,
          run_type: "chain", // Or 'tool', 'llm', etc.
          inputs: {}, // Provide relevant inputs
          tags: tags,
          // Attempt correlation (check LangSmith SDK docs for exact fields):
          parent_run_id: parentRunId || otelTraceId, // Example: Prefer explicit parent, fallback to OTLP traceId
          extra: { // Or use metadata/extra field
            metadata: {
              otelTraceId: otelTraceId,
              otelSpanId: otelSpanId,
            },
          },
        });
        return runId; // Return the ID used
      } catch (error) {
        console.error("Failed to create LangSmith run:", error);
        return runId; // Return local ID on error
      }
    }

    export async function trackFeedback(
      runId: string, // The LangSmith run ID (correlate this with OTLP traceId if possible)
      feedback: { score?: number; comment?: string; key?: string; value?: any; }
    ): Promise<boolean> {
      if (!langSmithClient) return false;
      try {
        await langSmithClient.createFeedback(runId, feedback.key || `feedback_${Date.now()}`, {
          score: feedback.score,
          comment: feedback.comment,
          value: feedback.value,
        });
        return true;
      } catch (error) {
        console.error(`Failed to track feedback for run ${runId}:`, error);
        return false;
      }
    }
    ```

*   **Implementation Code (OTLP Correlation Pattern):**

    ```typescript
    // Snippet for OTLP Correlation Pattern Implementation
    import { trace, context } from '@opentelemetry/api';
    import { langfuseService } from './langfuse';
    import { createLangSmithRun, trackFeedback } from './langsmith';

    async function performActionAndLog(actionData: any) {
      // --- Get OTLP Context ---
      const currentSpan = trace.getSpan(context.active());
      const traceId = currentSpan?.spanContext().traceId;
      const spanId = currentSpan?.spanContext().spanId;
      const otelMetadata = { otelTraceId: traceId, otelSpanId: spanId };
      console.log("OTel Context:", otelContext);

      // --- Example: Log Generation to Langfuse ---
      try {
        await langfuseService.logGeneration("some-generation", {
          traceId: traceId, // Pass traceId if Langfuse uses it directly
          input: actionData.input,
          output: actionData.output,
          metadata: { ...otelMetadata, /* other metadata */ }
        });
      } catch (e) { console.error("Langfuse logGeneration error:", e); }

      // --- Example: Create LangSmith Run ---
      let langsmithRunId: string | undefined;
      try {
        // Pass OTLP traceId as parent_run_id (example correlation)
        langsmithRunId = await createLangSmithRun(
          "some-action",
          ["tag1"],
          traceId, // Pass OTLP traceId
          spanId,  // Pass OTLP spanId
          traceId  // Example: Using traceId as parentRunId
        );
      } catch (e) { console.error("LangSmith createRun error:", e); }

      // --- Example: Track Feedback to LangSmith Run ---
      if (langsmithRunId && actionData.feedback) {
        try {
          await trackFeedback(langsmithRunId, actionData.feedback);
        } catch (e) { console.error("LangSmith trackFeedback error:", e); }
      }
    }
    ```

*   `SUG-IMPL-LOGDRAIN-002`: "@workspace Show the code using `@opentelemetry/api` to get the current OTLP `traceId` and `spanId`."
*   `SUG-IMPL-LOGDRAIN-003`: "@workspace Modify `#file:functions/src/mastra/tools/rlFeedback.ts#collectFeedbackTool` to implement the OTLP Correlation Pattern. Retrieve `traceId` and `spanId` using `@opentelemetry/api` and pass them in the `createScore` call to `langfuseService`, both directly as `traceId`/`spanId` if supported, and within the `metadata` object."

---

## 7. Debugging Guide (Streaming Focus - `mastra dev` - `GOAL-001`)

_(**CRITICAL PRIORITY**. Systematic steps within `mastra dev`)_

*   `DEBUG-SYMPTOM-001`: `writerAgent` stream fails instantly via `http://localhost:4111/chat`.
*   `DEBUG-LOCATION-001`: Likely within `writerAgent` execution, its call to the Vercel AI SDK (`streamText`), the LLM interaction, or the `mastra dev` server's SSE handling. See `REL-FLOW-002` explanation in Section 7 of v1.7.

*   **Debugging Steps & Code:**
    1.  **`DEBUG-STEP-01` (Check Console - Vital):** Run `pnpm dev` in `functions`. Trigger stream. Watch terminal **closely** for *any* errors/stack traces.
    2.  **`DEBUG-STEP-02` (Increase Verbosity):** Run `mastra dev --verbose`. Look for detailed Mastra/SDK logs.
    3.  **`DEBUG-STEP-03` (Isolate LLM Call - Vital):** Run standalone `test-stream.js`. Does direct SDK streaming work?
        *   `SUG-DEBUG-001`: "@workspace Generate `test-stream.js` using `@ai-sdk/google-vertex` for `gemini-1.5-flash`, handling auth and printing chunks."
    4.  **`DEBUG-STEP-04` (Log Inside Agent - Vital):** Add detailed `try...catch` around the `streamText` call.
        *   **Action:** Locate where `streamText` (or equivalent) is invoked for agents (likely within `COMP-AGENT-FACTORY` or a delegated method). Add extensive logging.

        ```typescript
        // Example try...catch for DEBUG-STEP-04 (Place in relevant execution path)
        try {
          console.log(`[DEBUG-STEP-04] Attempting streamText for agent ${agentConfig.id} with input:`, JSON.stringify(promptData));
          const stream = await streamText({ /* model, prompt, etc. */ });
          console.log(`[DEBUG-STEP-04] streamText call succeeded for agent ${agentConfig.id}.`);
          // ... return or process stream ...
        } catch (error) {
          console.error(`[DEBUG-STEP-04] >>> STREAMING ERROR CAUGHT for agent ${agentConfig.id} <<<`);
          console.error('[DEBUG-STEP-04] Error:', error); // Log the full error object
          throw error;
        }
        ```

        *   `SUG-DEBUG-002`: "@workspace Help locate where the Vercel AI SDK streaming call (like `streamText`) occurs for agents created by `COMP-AGENT-FACTORY` in `#file:functions/src/mastra/agents/base.agent.ts` and add the detailed `try...catch` block shown in `FILE-CONTEXT-COPILOT` section 7 (`DEBUG-STEP-04`)."
  
    5.  **`DEBUG-STEP-05` (Check Dependencies):** Verify versions (`FILE-PKG-BACKEND`). `pnpm install`.
    6.  **`DEBUG-STEP-06` (Simplify Agent Config):** Remove `toolIds`, simplify `instructions` in `writer.config.ts`. Test.
    7.  **`DEBUG-STEP-07` (Check Credentials):** Verify Google Cloud credentials for `mastra dev`.
    8.  **`DEBUG-STEP-08` (Check Frontend):** Log raw chunks in `FILE-COMP-STREAMCHAT`. Verify URL (`http://localhost:4111/chat`).
    9.  **`DEBUG-STEP-09` (Check Hooks):** Add `try...catch` to `writerAgent` response hooks (defined/applied likely in `FILE-AGENT-BASE`).
    10. **`DEBUG-STEP-10` (Check Tracing - Requires GOAL-002):** Examine SigNoz traces for errors/incomplete spans.

*   `PLAN-DEBUG-001`: "@workspace Use the Software Planning Tool: `start_planning` goal='Fix Mastra Streaming Issue (GOAL-001)'. Add `add_todo` items for each `DEBUG-STEP-*`, explaining the hypothesis."

---

## 8. Supporting Files Code (Reference)

*   **`functions/src/mastra/agents/config/config.types.ts`:** Defines `BaseAgentConfig`, `ModelConfig`, `ModelProvider`, `DEFAULT_MODELS`, etc. Crucial for understanding agent configuration structure. *(Full code omitted for brevity, assume structure based on usage in `base.agent.ts` and `*.config.ts` files)*
*   **`functions/src/mastra/agents/config/model.utils.ts`:** Contains `createModelInstance` used by `COMP-AGENT-FACTORY`. Handles logic for creating `@ai-sdk/google` or `@ai-sdk/google-vertex` instances based on `ModelConfig`. *(Full code omitted)*
*   **`functions/src/mastra/database/index.ts`:** Initializes `sharedMemory` using `LibSQLStore`. *(Full code omitted)*
*   **`functions/src/mastra/tools/readwrite.ts`, `./vectorquerytool.ts`, etc.:** Implementations of native Mastra tools using `createTool`. *(Full code omitted)*
*   **`functions/src/mastra/tools/calculator.ts`, `./exa.ts`, etc.:** Implementations adapting `@agentic/*` tools using `createMastraTools`. *(Full code omitted)*

---

## 9. Core Patterns Summary

*   **Telemetry Integration (`IMPL-LOGDRAIN-003`):** Configure `telemetry` in `mastra.config.ts`, pass to `Mastra` constructor in `mastra/index.ts`, remove `server` config.
*   **Agent Factory (`COMP-AGENT-FACTORY`):** Centralize agent creation in `base.agent.ts`, resolve tools using `toolIds` from config against central `allToolsMap`.
*   **Tool Adapter (`COMP-ADAPTER-MASTRA`):** Use `createMastraTools` in `tools/index.ts` to adapt external tools.
*   **OTLP Correlation (`REL-OBS-004`):** Use `@opentelemetry/api` to get `traceId`/`spanId` and include in programmatic Langfuse/LangSmith calls.

---

## 10. Tag Legend (Reference)

*   `GOAL-`: Project or Development Goals
*   `FIND-`: Specific Findings/Observations from Analysis
*   `ARCH-`: Architectural Patterns or Decisions
*   `FILE-`: Files or Directories
*   `COMP-`: Software Components
*   `REL-`: Relationships or Data Flow between Components
*   `CONV-`: Conventions or Standards
*   `BOUND-`: Boundaries, Constraints, or Negative Rules
*   `DEBUG-`: Information or steps related to debugging
*   `IMPL-`: Information or steps related to implementing features
*   `SUG-`: Suggested actions or Copilot interactions
*   `EXT-CTX-`: External Context Resource
*   `PLAN-`: Guidance related to using the Software Planning Tool

---

## 11. External Context References (Reference)

-   `EXT-CTX-001`: MastraDocs (For `Mastra` constructor, `Agent` API, `Tool` interface, Telemetry options)
-   `EXT-CTX-003`: MastraChanges (For dependency version issues `DEBUG-STEP-05`)
-   `EXT-CTX-009`: Langfuse/LangSmith Docs (For SDK usage in correlation `IMPL-LOGDRAIN-005`)
-   `EXT-CTX-010`: OpenTelemetry Docs (For `@opentelemetry/api` usage `IMPL-LOGDRAIN-005`, Env Vars)

---

## 12. Maintenance Note

This document (v7.0) reflects the codebase state analyzed on **April 14, 2025**. Update after resolving goals or making structural changes.