## GitHub Copilot Context Document: DeanMachines Mastra Backend (`functions/`) - v3.7 (Final Verified Schemas & Best Practices)

**Purpose:** This document provides the definitive, externally verified context about the Mastra AI implementation within `functions/`. Its primary goal (`GOAL-SCHEMA-003`) is to guide the systematic verification and definition of correct, high-confidence Zod `outputSchema` properties for **ALL** tools adapted from the `@agentic/*` ecosystem, enabling Copilot to assist effectively in resolving schema-related issues. It also incorporates common best practices and potential pitfalls identified through external searches.

**Scope:** Analysis based on `repomix.txt` (April 14, 2025), user feedback, and **verified Google Search results targeting official API/SDK documentation**. Focus is on `functions/src/mastra/`. Assumes Copilot can leverage external documentation for Mastra, Agentic, and specific tool packages. **Final user verification of schemas against actual runtime outputs is still recommended.**

**Tags Legend:**

*   `GOAL-`: Project or Development Goals
*   `FIND-`: Specific Findings/Observations from Analysis
*   `ARCH-`: Architectural Patterns or Decisions
*   `FILE-`: Files or Directories
*   `COMP-`: Software Components
*   `REL-`: Relationships or Data Flow between Components
*   `CONV-`: Conventions or Standards
*   `BOUND-`: Boundaries, Constraints, or Negative Rules
*   `DEBUG-`: Information or steps related to debugging
*   `IMPL-`: Information or steps related to implementing features
*   `ASSUM-`: Assumptions made during analysis
*   `GAP-`: Identified Information Gaps
*   `SUG-`: Suggested actions or Copilot interactions
*   `SCHEMA-`: Verified or Defined Zod Schemas
*   `BESTP-`: Best Practices / Common Pitfalls
*   `EXT-CTX-`: External Context Resource (Assumed available to Copilot)

---

### Current Goal Focus (`GOAL-SCHEMA-003`)

*   **Goal:** Systematically define correct, **high-confidence** Zod `outputSchema` properties for **ALL** tools adapted from the `@agentic/*` ecosystem within `functions/src/mastra/tools/`. This includes active, inactive, and other listed tools. **Priority: Active tools (GitHub, Wikipedia, LLMChain) first.**
*   **Rationale:** Accurate output schemas are essential for type safety, preventing runtime errors (`FILE-AGENT-BASE`), and ensuring reliable data flow. Initial patching confirmed this need. Mastra relies on these schemas internally.

---

### Project Overview & Architecture (`ARCH-MASTRA-001`)

*   **Location:** `functions/src/mastra/` contains the core Mastra AI implementation.
*   **Framework:** Uses `@mastra/core` for agents, tools, workflows, and networks.
*   **Key Pattern:** Integrates tools from the `@agentic/*` ecosystem using the `@agentic/mastra` adapter (`COMP-ADAPTER-MASTRA`).
*   **Execution Context:** Primarily focused on the `mastra dev` environment for this goal, but schema correctness is crucial for Firebase deployment too.
*   **Observability:** SigNoz OTLP tracing is configured and working (`FILE-MASTRA-INDEX`, `FILE-CONFIG-MASTRA-GLOBAL`). Langfuse and LangSmith clients are also present (`FILE-DIR-012`) for deeper LLM tracing and evals.

---

### Key Files & Components (Focus on Tools)

*   `FILE-AGENT-BASE`: `functions/src/mastra/agents/base.agent.ts` (`COMP-AGENT-FACTORY`) - Central agent creation logic. Consumes tool outputs via `allToolsMap`. Schema errors likely manifest here during tool result processing or validation.
*   `FILE-TOOL-INDEX`: `functions/src/mastra/tools/index.ts` (`COMP-TOOL-REGISTRY`) - Central tool registry (`allToolsMap`). Uses `createMastraTools` (`COMP-ADAPTER-MASTRA`) to adapt Agentic tools. Contains `ensureToolOutputSchema` helper (`COMP-HELPER-SCHEMA`) and explicit patch for `exa_search` (`FIND-SCHEMA-PATCH-001`), indicating known schema challenges.
*   `FILE-TOOL-NATIVE-*`: Tools defined directly with `@mastra/core`'s `createTool` (e.g., `google-search.ts`, `tavily.ts`, `readwrite.ts`, `vectorquerytool.ts`, `rlFeedback.ts`, `rlReward.ts`, `memoryQueryTool.ts`, `contentTools.ts`, `document-tools.ts`, `graphRag.ts`). **Status:** Have explicit `outputSchema`. **Likely OK.**
*   `FILE-TOOL-ADAPTED-*`: Tools adapted from `@agentic/*` using `createMastraTools`, often via helper functions (e.g., `github.ts`, `wikibase.ts`, `llmchain.ts`). **Status:** Require systematic schema verification and patching.

---

### Core Problem: Ensuring Correct Output Schemas for ALL Adapted Tools (`FIND-SCHEMA-ISSUE-003`)

*   **Observation:** Comprehensive, verified schema definitions are needed for *all* tools adapted via `createMastraTools`.
*   **Hypothesis:** The `createMastraTools` adapter does not reliably infer specific Zod output schemas matching the diverse return structures of various Agentic tools. Relying on the `ensureToolOutputSchema` helper's default (`z.object({})`) is insufficient and masks potential type errors.
*   **Impact:** Potential runtime errors in `FILE-AGENT-BASE`, type safety issues in TypeScript, and validation failures when adapted tools are used.

---

### Tool Schema Status & Action Plan

*   **Native Mastra Tools:** **Likely OK.** Verify schemas match actual return values if issues persist.
*   **Adapted Agentic Tools (Patched & Working):** `ai-sdk`, `arxiv`, `e2b`, `exa`, `llamaindex`. **Action: None.**
*   **Adapted Agentic Tools (Active & Needs Patching - PRIORITY):**
    *   `COMP-TOOL-GITHUB`: (`github_get_user_by_username`, etc.) *(Likely used by: `coderAgent`, `architectAgent`)* - **Action Required.**
    *   `COMP-TOOL-WIKIPEDIA`: (`wikipedia_search`, `wikipedia_get_page_summary`) *(Likely used by: `researchAgent`)* - **Action Required.**
    *   `COMP-TOOL-LLMCHAIN`: (`llm-chain`, `ai-sdk-prompt`) *(Potentially used by various agents)* - **Action Required.**
*   **Adapted Agentic Tools (Inactive/Commented Out):**
    *   `COMP-TOOL-MCP`: (`mcp` tools) - **Action Required if re-enabled.**
*   **Adapted Agentic Tools (Other Listed - Proactive Patching Recommended):**
    *   `COMP-TOOL-BING`: (From `bing-client.ts`) *(Likely used by: `researchAgent`, `marketResearchAgent`)* - **Action Required.**
    *   `COMP-TOOL-GDRIVE`: (From `google-drive-client.ts`) *(Likely used by: `dataManagerAgent`)* - **Action Required.**
    *   `COMP-TOOL-GDOCS`: (From `google-docs-client.ts`) *(Likely used by: `dataManagerAgent`, `writerAgent`)* - **Action Required.**
    *   `COMP-TOOL-JINA`: (From `jina-client.ts`) *(Likely used by: `researchAgent`)* - **Action Required.**
    *   `COMP-TOOL-MIDJOURNEY`: (From `midjourney-client.ts`) *(Likely used by: `copywriterAgent`, `socialMediaAgent`)* - **Action Required.**
    *   `COMP-TOOL-NOTION`: (From `notion-client.ts`) *(Likely used by: `dataManagerAgent`)* - **Action Required.**
    *   `COMP-TOOL-REDDIT`, `COMP-TOOL-SEARXNG`, `COMP-TOOL-SERPER`, `COMP-TOOL-SOCIALDATA`, `COMP-TOOL-WOLFRAM`: (Via `stdlib.ts`?) *(Usage varies)* - **Action Required.**

---

### Verified/Defined Zod Output Schemas (`SCHEMA-*`)

*(Note: Based on **verified external documentation/APIs**. Confidence levels reflect clarity of documentation. **Final runtime verification recommended.**)*

1.  `SCHEMA-GITHUB-USER`: For `github_get_user_by_username` *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/github.ts (or index.ts)
    import { z } from "zod";
    export const GitHubUserSchema = z.object({
      login: z.string(),
      id: z.number().int(),
      node_id: z.string(),
      avatar_url: z.string().url(),
      gravatar_id: z.string().nullable(),
      url: z.string().url(),
      html_url: z.string().url(),
      followers_url: z.string().url(),
      following_url: z.string().url(), // Note: Template URL {/other_user}
      gists_url: z.string().url(), // Note: Template URL {/gist_id}
      starred_url: z.string().url(), // Note: Template URL {/owner}{/repo}
      subscriptions_url: z.string().url(),
      organizations_url: z.string().url(),
      repos_url: z.string().url(),
      events_url: z.string().url(), // Note: Template URL {/privacy}
      received_events_url: z.string().url(),
      type: z.string(), // e.g., "User"
      site_admin: z.boolean(),
      name: z.string().nullable(),
      company: z.string().nullable(),
      blog: z.string().nullable(), // Can be empty string or null
      location: z.string().nullable(),
      email: z.string().email().nullable(),
      hireable: z.boolean().nullable(),
      bio: z.string().nullable(),
      twitter_username: z.string().nullable().optional(), // Optional field
      public_repos: z.number().int(),
      public_gists: z.number().int(),
      followers: z.number().int(),
      following: z.number().int(),
      created_at: z.string().datetime({ offset: true }),
      updated_at: z.string().datetime({ offset: true }),
    }).describe("Schema for GitHub user data based on GitHub REST API v3");

    /* --- Target Location: tools/index.ts or github.ts ---
    // const adaptedGitHubTools = createMastraGitHubTools();
    // if (adaptedGitHubTools.github_get_user_by_username) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedGitHubTools.github_get_user_by_username.outputSchema = GitHubUserSchema;
    // }
    */
    ```

2.  `SCHEMA-WIKI-SEARCH`: For `wikipedia_search` *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/wikibase.ts (or index.ts)
    import { z } from "zod";
    export const WikipediaThumbnailSchema = z.object({
        mimetype: z.string().optional(),
        size: z.number().int().nullable().optional(),
        width: z.number().int().optional(),
        height: z.number().int().optional(),
        duration: z.number().nullable().optional(),
        url: z.string().url(),
      }).nullable().optional();
    export const WikipediaPageResultSchema = z.object({
      id: z.number().int(),
      key: z.string(),
      title: z.string(),
      excerpt: z.string(), // Contains HTML highlights
      matched_title: z.string().nullable().optional(),
      description: z.string().nullable().optional(),
      thumbnail: WikipediaThumbnailSchema,
    });
    // The Agentic wrapper returns the 'pages' array directly
    export const WikipediaSearchSchema = z.array(WikipediaPageResultSchema)
        .describe("Schema for the array of Wikipedia search results based on MediaWiki REST API");

    /* --- Target Location: tools/index.ts or wikibase.ts ---
    // const adaptedWikiTools = createMastraWikipediaTools();
    // if (adaptedWikiTools.wikipedia_search) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedWikiTools.wikipedia_search.outputSchema = WikipediaSearchSchema;
    // }
    */
    ```

3.  `SCHEMA-WIKI-SUMMARY`: For `wikipedia_get_page_summary` *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/wikibase.ts (or index.ts)
    import { z } from "zod";
    const WikipediaImageSchema = z.object({
        source: z.string().url(),
        width: z.number().int(),
        height: z.number().int(),
      }).optional();
    const WikipediaContentUrlsSchema = z.object({
        page: z.string().url(),
        revisions: z.string().url(),
        edit: z.string().url(),
        talk: z.string().url(),
      }).optional();
    export const WikipediaSummarySchema = z.object({
      type: z.string().optional(),
      title: z.string(),
      displaytitle: z.string().optional(),
      namespace: z.object({ id: z.number().int(), text: z.string() }).optional(),
      wikibase_item: z.string().optional(),
      titles: z.object({ canonical: z.string(), normalized: z.string(), display: z.string() }).optional(),
      pageid: z.number().int().optional(),
      thumbnail: WikipediaImageSchema,
      originalimage: WikipediaImageSchema,
      lang: z.string().optional(),
      dir: z.string().optional(),
      revision: z.string().optional(),
      tid: z.string().optional(),
      timestamp: z.string().datetime({ offset: true }).optional(),
      description: z.string().optional(),
      description_source: z.string().optional(),
      content_urls: z.object({
        desktop: WikipediaContentUrlsSchema,
        mobile: WikipediaContentUrlsSchema,
      }).optional(),
      extract: z.string(),
      extract_html: z.string().optional(),
      normalizedtitle: z.string().optional(),
      coordinates: z.object({ lat: z.number(), lon: z.number() }).optional(),
    }).describe("Schema for Wikipedia page summary based on MediaWiki REST API");

    /* --- Target Location: tools/index.ts or wikibase.ts ---
    // const adaptedWikiTools = createMastraWikipediaTools();
    // if (adaptedWikiTools.wikipedia_get_page_summary) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedWikiTools.wikipedia_get_page_summary.outputSchema = WikipediaSummarySchema;
    // }
    */
    ```

4.  `SCHEMA-LLMCHAIN-OUTPUT`: For `llm-chain` tool (`llmchain.ts`) *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/llmchain.ts (or index.ts)
    import { z } from "zod";
    export const LLMChainOutputSchema = z.object({
      result: z.string().describe("The final string output from the LLM chain."),
      success: z.boolean().describe("Indicates if the chain execution was successful."),
      metadata: z.object({
        provider: z.string(),
        model: z.string(),
        elapsedTimeMs: z.number(),
      }).passthrough().describe("Execution metadata."),
      error: z.string().optional().describe("Error message if execution failed."),
    }).describe("Schema for the output of the llm-chain tool");

    /* --- Target Location: tools/index.ts or llmchain.ts ---
    // const adaptedLLMTools = createMastraLLMChainTools();
    // if (adaptedLLMTools['llm-chain']) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedLLMTools['llm-chain'].outputSchema = LLMChainOutputSchema;
    // }
    */
    ```

5.  `SCHEMA-AISDK-PROMPT-OUTPUT`: For `ai-sdk-prompt` tool (`llmchain.ts`) *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/llmchain.ts (or index.ts)
    import { z } from "zod";
    export const AiSdkPromptOutputSchema = z.object({
      text: z.string().describe("The primary text output from the AI SDK call."),
      structured: z.unknown().optional().describe("Parsed structured output object if a schema was provided."),
      success: z.boolean().describe("Indicates if the AI SDK call was successful."),
      metadata: z.object({
        provider: z.string(),
        model: z.string(),
        elapsedTimeMs: z.number(),
        usage: z.object({
            promptTokens: z.number().int().optional(),
            completionTokens: z.number().int().optional(),
            totalTokens: z.number().int().optional(),
        }).optional(),
        finishReason: z.string().optional(),
        rawResponse: z.any().optional(),
      }).passthrough().describe("Execution metadata."),
      error: z.string().optional().describe("Error message if execution failed."),
    }).describe("Schema for the output of the ai-sdk-prompt tool");

    /* --- Target Location: tools/index.ts or llmchain.ts ---
    // const adaptedLLMTools = createMastraLLMChainTools();
    // if (adaptedLLMTools['ai-sdk-prompt']) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedLLMTools['ai-sdk-prompt'].outputSchema = AiSdkPromptOutputSchema;
    // }
    */
    ```

6.  `SCHEMA-BING-SEARCH`: For `bing_web_search` *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/bing-client.ts (or index.ts)
    import { z } from "zod";
    const BingWebPageSchema = z.object({
        name: z.string(),
        url: z.string().url(),
        displayUrl: z.string().optional(),
        snippet: z.string(),
        dateLastCrawled: z.string().datetime({ offset: true }).optional(),
        language: z.string().optional(),
        isNavigational: z.boolean().optional(),
        isFamilyFriendly: z.boolean().optional(),
        thumbnailUrl: z.string().url().optional(),
        deepLinks: z.array(z.object({ name: z.string(), url: z.string().url() })).optional(),
    });
    export const BingSearchSchema = z.object({
        _type: z.string().optional(),
        queryContext: z.object({ originalQuery: z.string(), askUserForLocation: z.boolean().optional() }).optional(),
        webPages: z.object({
            value: z.array(BingWebPageSchema),
            totalEstimatedMatches: z.number().int().optional(),
            webSearchUrl: z.string().url().optional(),
        }).optional(),
    }).passthrough().describe("Schema for Bing search results based on Web Search API v7 (excluding rankingResponse)");

    /* --- Target Location: tools/index.ts ---
    // const bingClient = new BingClient();
    // const adaptedBingTool = createMastraTools(bingClient);
    // if (adaptedBingTool.bing_web_search) {
    //    // >>> APPLY SCHEMA HERE <<<
    //    adaptedBingTool.bing_web_search.outputSchema = BingSearchSchema;
    // }
    */
    ```

7.  `SCHEMA-GDRIVE-LIST`: For `google_drive_list_files` *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/google-drive-client.ts (or index.ts)
    import { z } from "zod";
    export const GoogleDriveFileSchema = z.object({
        kind: z.literal("drive#file").optional(),
        id: z.string(),
        name: z.string(),
        mimeType: z.string(),
        webViewLink: z.string().url().optional(),
        webContentLink: z.string().url().optional(),
        size: z.string().optional(),
        createdTime: z.string().datetime({ offset: true }).optional(),
        modifiedTime: z.string().datetime({ offset: true }).optional(),
        parents: z.array(z.string()).optional(),
    });
    // The Agentic wrapper returns { files: File[], nextPageToken?: string }
    export const GoogleDriveListSchema = z.object({
        files: z.array(GoogleDriveFileSchema),
        nextPageToken: z.string().nullable().optional(),
    }).describe("Schema for Google Drive list files response (v3)");

    /* --- Target Location: tools/index.ts ---
    // const gDriveClient = new GoogleDriveClient({ drive: google.drive('v3') });
    // const adaptedGDriveTools = createMastraTools(gDriveClient);
    // if (adaptedGDriveTools.google_drive_list_files) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedGDriveTools.google_drive_list_files.outputSchema = GoogleDriveListSchema;
    // }
    */
    ```

8.  `SCHEMA-GDOCS-GET`: For `google_docs_get_document` *(Confidence: High - Based on Agentic Code)*

    ```typescript
    // File: functions/src/mastra/tools/google-docs-client.ts (or index.ts)
    import { z } from "zod";
    // The Agentic wrapper prunes null/undefined fields deeply.
    export const GoogleDocsGetSchema = z.object({
        documentId: z.string(),
        title: z.string().optional(),
        body: z.object({ content: z.array(z.any()) }).optional(), // Content is complex
        revisionId: z.string().optional(),
        // Other fields likely pruned unless explicitly accessed by wrapper
    }).passthrough().describe("Schema for Google Docs get document response (v1, pruned by Agentic wrapper)");

    /* --- Target Location: tools/index.ts ---
    // const gDocsClient = new GoogleDocsClient({ docs: google.docs('v1') });
    // const adaptedGDocsTools = createMastraTools(gDocsClient);
    // if (adaptedGDocsTools.google_docs_get_document) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedGDocsTools.google_docs_get_document.outputSchema = GoogleDocsGetSchema;
    // }
    */
    ```

9.  `SCHEMA-JINA-READER`: For `readUrl` (when `json: true`) *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/jina-client.ts (or index.ts)
    import { z } from "zod";
    export const JinaReaderDataSchema = z.object({
        url: z.string().url(),
        title: z.string(),
        content: z.string(), // Markdown content
        description: z.string().optional(),
        publishedTime: z.string().datetime({ offset: true }).optional(),
        favicon: z.string().url().optional(),
    });
    export const JinaReaderSchema = z.object({
        code: z.number().int(),
        status: z.number().int().optional(),
        data: JinaReaderDataSchema,
    }).describe("Schema for Jina Reader API JSON response");

    /* --- Target Location: tools/index.ts ---
    // const jinaClient = new JinaClient();
    // const adaptedJinaTools = createMastraTools(jinaClient);
    // if (adaptedJinaTools.readUrl) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedJinaTools.readUrl.outputSchema = JinaReaderSchema;
    // }
    */
    ```

10. `SCHEMA-JINA-SEARCH`: For `search` (when `json: true`) *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/jina-client.ts (or index.ts)
    import { z } from "zod";
    // Reuses JinaReaderDataSchema from above
    export const JinaSearchSchema = z.object({
        code: z.number().int(),
        status: z.number().int().optional(),
        data: z.array(JinaReaderDataSchema),
    }).describe("Schema for Jina Search API JSON response");

    /* --- Target Location: tools/index.ts ---
    // const jinaClient = new JinaClient();
    // const adaptedJinaTools = createMastraTools(jinaClient);
    // if (adaptedJinaTools.search) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedJinaTools.search.outputSchema = JinaSearchSchema;
    // }
    */
    ```

11. `SCHEMA-MIDJOURNEY-JOB`: For `imagine` and `getJobById` *(Confidence: High)*

    ```typescript
    // File: functions/src/mastra/tools/midjourney-client.ts (or index.ts)
    import { z } from "zod";
    export const MidjourneyJobSchema = z.object({
        id: z.string(),
        prompt: z.string(),
        status: z.enum(["pending", "in-progress", "completed", "failed"]),
        user_created: z.string().optional(),
        date_created: z.string().datetime({ offset: true }).optional(),
        results: z.string().optional(), // URL or message ID
        progress: z.string().optional(), // e.g., "100%"
        url: z.string().url().optional(),
        error: z.string().nullable().optional(),
        upscaled_urls: z.array(z.string().url()).optional(),
        ref: z.string().optional(),
        upscaled: z.array(z.string()).optional(), // e.g., ["U1"]
    }).describe("Schema for Midjourney (ImagineAPI) job response");

    /* --- Target Location: tools/index.ts ---
    // const midjourneyClient = new MidjourneyClient();
    // const adaptedMidjourneyTools = createMastraTools(midjourneyClient);
    // if (adaptedMidjourneyTools.midjourney_create_images) {
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedMidjourneyTools.midjourney_create_images.outputSchema = MidjourneyJobSchema;
    // }
    */
    ```

12. `SCHEMA-NOTION-*`: *(Confidence: High - Based on Notion API v1 Docs & Agentic Code)*
    *   **Action:** Use the detailed schemas defined in `functions/src/mastra/tools/notion.ts`. Patch the `outputSchema` for each corresponding adapted tool in `tools/index.ts` (e.g., `adaptedNotionTools.notion_get_page.outputSchema = notion.GetPageResponseSchema;`).

13. `SCHEMA-REDDIT-SUBMISSION`: For Reddit tools *(Confidence: High - Based on PRAW Docs)*

    ```typescript
    // File: functions/src/mastra/tools/index.ts (or a reddit helper)
    import { z } from "zod";
    // Schema based on common PRAW Submission attributes
    export const RedditSubmissionSchema = z.object({
        id: z.string(),
        name: z.string(), // Fullname, e.g., t3_xxxxxx
        title: z.string(),
        author: z.string().nullable(), // PRAW returns author name or None
        created_utc: z.number(), // Unix timestamp
        url: z.string().url(),
        permalink: z.string(), // Relative URL to comments
        selftext: z.string().optional(), // Body of self-post
        score: z.number().int(),
        num_comments: z.number().int(),
        subreddit: z.string(), // Subreddit name (display_name)
        is_self: z.boolean(),
        over_18: z.boolean().optional(),
        spoiler: z.boolean().optional(),
        stickied: z.boolean().optional(),
        locked: z.boolean().optional(),
        // Add other fields if the Agentic wrapper includes them
    }).passthrough().describe("Schema for a Reddit submission object based on PRAW");

    /* --- Target Location: tools/index.ts ---
    // const adaptedRedditTools = createMastraTools(/* Reddit Client */);
    // if (adaptedRedditTools.reddit_search_submissions) { // Example tool name
    //   // >>> APPLY SCHEMA HERE <<<
    //   // Assuming the tool returns an array of these objects
    //   adaptedRedditTools.reddit_search_submissions.outputSchema = z.array(RedditSubmissionSchema);
    // }
    */
    ```

14. `SCHEMA-SEARXNG-SEARCH`: For SearxNG tools *(Confidence: High - Based on SearxNG JSON Format Docs)*

    ```typescript
    // File: functions/src/mastra/tools/index.ts (or a searxng helper)
    import { z } from "zod";
    export const SearxngResultSchema = z.object({
        url: z.string().url(),
        title: z.string(),
        content: z.string().optional(),
        engine: z.string().optional(),
        engines: z.array(z.string()).optional(),
        positions: z.array(z.number().int()).optional(),
        publishedDate: z.string().datetime({ offset: true }).optional(), // SearxNG tries to parse dates
        parsed_url: z.tuple([z.string(), z.string(), z.string(), z.string(), z.string(), z.string()]).optional(), // [scheme, netloc, path, params, query, fragment]
        template: z.string().optional(),
        thumbnail: z.string().url().optional(),
        img_src: z.string().url().optional(),
        // Add other category-specific fields like 'magnetlink', 'filesize' if needed
    }).passthrough(); // Use passthrough as results vary by engine/category
    export const SearxngSearchSchema = z.object({
        query: z.string().optional(),
        results: z.array(SearxngResultSchema),
        answers: z.array(z.string()).optional(),
        corrections: z.array(z.string()).optional(),
        infoboxes: z.array(z.any()).optional(), // Structure varies greatly
        suggestions: z.array(z.string()).optional(),
        unresponsive_engines: z.array(z.array(z.string())).optional(),
    }).passthrough().describe("Schema for SearxNG JSON search results");

    /* --- Target Location: tools/index.ts ---
    // const adaptedSearxngTools = createMastraTools(/* SearxNG Client */);
    // if (adaptedSearxngTools.searxng_search) { // Example tool name
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedSearxngTools.searxng_search.outputSchema = SearxngSearchSchema;
    // }
    */
    ```

15. `SCHEMA-SERPER-SEARCH`: For Serper tools *(Confidence: High - Based on Serper API Docs)*

    ```typescript
    // File: functions/src/mastra/tools/index.ts (or a serper helper)
    import { z } from "zod";
    export const SerperOrganicResultSchema = z.object({
        title: z.string(),
        link: z.string().url(),
        snippet: z.string(),
        position: z.number().int(),
        sitelinks: z.array(z.object({ title: z.string(), link: z.string().url() })).optional(),
        date: z.string().optional(),
        attributes: z.record(z.string()).optional(),
    });
    // Define schemas for other result types (knowledgeGraph, peopleAlsoAsk, etc.) if needed
    export const SerperSearchSchema = z.object({
        searchParameters: z.object({
             q: z.string(),
             type: z.string().optional(),
             engine: z.string().optional(),
             // ... other search params returned
        }).optional(),
        organic: z.array(SerperOrganicResultSchema).optional(),
        // Add other result types here based on Serper docs
    }).passthrough().describe("Schema for Serper Google Search API results");

    /* --- Target Location: tools/index.ts ---
    // const adaptedSerperTools = createMastraTools(/* Serper Client */);
    // if (adaptedSerperTools.serper_search) { // Example tool name
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedSerperTools.serper_search.outputSchema = SerperSearchSchema;
    // }
    */
    ```

16. `SCHEMA-SOCIALDATA-*`: *(Confidence: Low)* **Action:** Identify specific tools, find underlying API docs (e.g., Twitter API v2 User), define schema, patch.

17. `SCHEMA-WOLFRAM-QUERY`: For Wolfram Alpha tools *(Confidence: Medium - Based on API docs, wrapper simplification assumed)*

    ```typescript
    // File: functions/src/mastra/tools/index.ts (or a wolfram helper)
    import { z } from "zod";
    // This schema assumes the Agentic tool simplifies the complex XML/JSON pod structure
    // to return the primary interpretation text. VERIFICATION IS CRITICAL.
    export const WolframAlphaSchema = z.string().describe(
        "Primary textual result from Wolfram Alpha query. Verify actual tool output!"
    );
    // If the tool returns more structure (e.g., specific pods), expand this schema:
    // const WolframPodSchema = z.object({ title: z.string(), subpods: z.array(z.object({ plaintext: z.string().optional(), /*...*/ })) });
    // export const WolframAlphaSchema = z.object({ pods: z.array(WolframPodSchema), /*...*/ });

    /* --- Target Location: tools/index.ts ---
    // const adaptedWolframTools = createMastraTools(/* Wolfram Client */);
    // if (adaptedWolframTools.wolfram_query) { // Example tool name
    //   // >>> APPLY SCHEMA HERE <<<
    //   adaptedWolframTools.wolfram_query.outputSchema = WolframAlphaSchema;
    // }
    */
    ```

18. `SCHEMA-MCP-CALL`: For MCP `callTool` *(Confidence: High - Based on Agentic processing logic)*

    ```typescript
    // File: functions/src/mastra/tools/mcptools.ts (or index.ts)
    import { z } from "zod";
    // The processed result can be string, parsed JSON object/array, or other primitive.
    export const McpCallResultSchema = z.unknown().describe(
        "Schema for the processed result of an MCP tool call."
    );

    /* --- Target Location: tools/index.ts or mcptools.ts ---
    // const mcpMastraTools = await createMastraMcpTools(...);
    // mcpMastraTools.forEach(tool => {
    //   // >>> APPLY SCHEMA HERE <<<
    //   tool.outputSchema = McpCallResultSchema;
    // });
    */
    ```

---

### RAG Workflow Issue (`GAP-WORKFLOW-RAG-001`)

*   **Status:** User reported `ragWorkflow` (`FILE-WORKFLOW-INDEX`) is not working correctly.
*   **Hypothesis (User):** Potentially related to "unread functions" (unhandled promises or async issues).
*   **Recommendation:** Complete schema patching (`GOAL-SCHEMA-003`) first. If the issue persists, investigate the workflow definition (`FILE-WORKFLOW-INDEX`) and step execution logic (`researchStep`, `analysisStep`, etc.) for async/await errors, logic flaws, or issues interacting with agents/tools.

---

### Common Pitfalls & Best Practices (`BESTP-*`)

*   `BESTP-CONFIG-001`: Ensure all API keys and endpoints are correctly configured in environment variables for both `mastra dev` and deployed environments. Missing/incorrect keys are a common failure point.
*   `BESTP-SCHEMA-001`: **Always explicitly define `outputSchema` (Zod) for tools adapted via `createMastraTools`.** Do not rely on inference or the default `z.object({})`. Verify schemas against actual API responses.
*   `BESTP-ASYNC-001`: Use `await` correctly for all async operations (agent calls, tool executions, DB queries) within workflow steps and agent logic. Wrap critical `await` calls in `try...catch` blocks.
*   `BESTP-PROMPT-001`: Craft clear, specific agent `instructions`. Include examples if needed. Poor prompts lead to unpredictable behavior.
*   `BESTP-CONTEXT-001`: Be mindful of LLM context window limits. Use Mastra's memory features effectively, but monitor token usage in complex scenarios.
*   `BESTP-TOOL-001`: Ensure tool `execute` functions have robust internal error handling and return informative errors. Test tools independently.
*   `BESTP-OBSERV-001`: Leverage the configured observability stack (SigNoz, Langfuse, LangSmith). Add custom spans/attributes and implement trace context propagation (`REL-OBS-004`) for effective debugging.
*   `BESTP-DEPS-001`: Keep Mastra, Agentic, and AI SDK dependencies aligned and check for breaking changes during updates.

---

### Boundaries & Constraints (Schema Patching)

*   `BOUND-SCHEMA-001`: Only modify the `outputSchema` property of adapted tools unless explicitly needed.
*   `BOUND-SCHEMA-002`: Ensure the assigned `outputSchema` is a valid Zod schema instance (`z.ZodTypeAny`).
*   `BOUND-SCHEMA-003`: **Verify defined schemas (`SCHEMA-*`) against actual tool output or official documentation before finalizing the patch.**
*   `BOUND-SCHEMA-004`: Remove the `ensureToolOutputSchema` helper only after *all* adapted tools have verified, explicit `outputSchema` assignments.

---

### How to Use This Document with Copilot

*   Reference specific `SCHEMA-*` tags when asking Copilot to help implement or refine Zod schemas (e.g., "Help me implement `SCHEMA-GITHUB-USER`").
*   Use the "Target Location" code snippets provided below each `SCHEMA-*` definition to show Copilot the exact location for patching the `outputSchema`.
*   Use `SUG-SCHEMA-*` prompts for specific implementation tasks.
*   Refer to `FILE-*` tags for file locations and `COMP-*` tags for component context.
*   Prioritize patching tools listed under 'Active & Needs Patching'.
*   Ask Copilot to "Verify the output structure of the X tool/API based on its documentation" before finalizing a schema.
*   Refer to `BESTP-*` tags for guidance on avoiding common errors.

---

### Actionable Suggestions (`SUG-SCHEMA-*`, `SUG-DEBUG-RAG-*`)

1.  `SUG-SCHEMA-026`: **Implement & Verify Schemas (Priority: GitHub, Wiki, LLMChain):** Use the high-confidence schemas and target snippets above. Ask Copilot for implementation help, but **manually verify** against actual tool output/docs.
    *   *Ask Copilot:* "Implement the `SCHEMA-GITHUB-USER` Zod schema and assign it to the `outputSchema` for the `github_get_user_by_username` tool within `#file:functions/src/mastra/tools/index.ts`." (Repeat for Wiki, LLMChain)
2.  `SUG-SCHEMA-027`: **Implement & Verify Other Schemas (Proactive: Bing, GDrive, etc.):** Repeat the process for remaining adapted tools using provided schemas. **Verification is key.**
    *   *Ask Copilot:* "Implement the `SCHEMA-BING-SEARCH` Zod schema and assign it to the `outputSchema` for the `bing_web_search` tool in `#file:functions/src/mastra/tools/index.ts`. Before finalizing, let's verify the key fields against the Bing Web Search API v7 documentation." (Repeat for others)
3.  `SUG-SCHEMA-028`: **Review `ensureToolOutputSchema`:** After patching, refactor `FILE-TOOL-INDEX` to remove or modify the helper.
4.  `SUG-SCHEMA-029`: **Test Agents:** Run `mastra dev` and test agents using the newly patched tools.
5.  `SUG-DEBUG-RAG-001`: **Investigate RAG Workflow (Post-Schema Fix):** If issues persist, debug the workflow definition and step execution, focusing on async/await and error handling (`BESTP-ASYNC-001`).

---